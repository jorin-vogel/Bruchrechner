(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M=Array.prototype.slice,N=Object.prototype.hasOwnProperty,O=function(a,b){function d(){this.constructor=a}for(var c in b)N.call(b,c)&&(a[c]=b[c]);d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype;return a},P=function(a,b){return function(){return a.apply(b,arguments)}};l=function(){var a;a=1<=arguments.length?M.call(arguments,0):[];return function(a,b,c){c.prototype=a.prototype;var d=new c,e=a.apply(d,b);return typeof e=="object"?e:d}(l.Object,a,function(){})},l.typeOf=j=function(a){return I.call(a).slice(8,-1)},I=Object.prototype.toString,l.mixin=g=function(){var a,b,c,d,e,f,g,h;e=arguments[0],d=2<=arguments.length?M.call(arguments,1):[],a=typeof e.set=="function";for(g=0,h=d.length;g<h;g++){c=d[g];if(j(c)!=="Object")continue;for(b in c){if(!N.call(c,b))continue;f=c[b];if(b==="initialize"||b==="uninitialize"||b==="prototype")continue;a?e.set(b,f):e.nodeName!=null?l.data(e,b,f):e[b]=f}typeof c.initialize=="function"&&c.initialize.call(e)}return e},l.unmixin=k=function(){var a,b,c,d,e,f;a=arguments[0],d=2<=arguments.length?M.call(arguments,1):[];for(e=0,f=d.length;e<f;e++){c=d[e];for(b in c){if(b==="initialize"||b==="uninitialize")continue;delete a[b]}typeof c.uninitialize=="function"&&c.uninitialize.call(a)}return a},l._block=a=function(a,b){var c,d;b!=null?c=a:b=a;return d=function(){var a,d,e;a=1<=arguments.length?M.call(arguments,0):[],d=this,e=function(c){a.push(c);return b.apply(d,a)};return typeof a[a.length-1]=="function"||c&&a.length>=c?e(a.pop()):e}},l._findName=d=function(a,b){var c,d;if(!a.displayName)for(c in b){d=b[c];if(d===a){a.displayName=c;break}}return a.displayName},l._functionName=e=function(a){var b;if(a.name)return a.name;return(b=a.toString().match(/\W*function\s+([\w\$]+)\(/))!=null?b[1]:void 0},r=/(?:^|_|\-)(.)/g,s=/(^|\s)([a-z])/g,A=/([A-Z]+)([A-Z][a-z])/g,B=/([a-z\d])([A-Z])/g,w=l.helpers={camelize:function(a,b){a=a.replace(r,function(a,b){return b.toUpperCase()});return b?a.substr(0,1).toLowerCase()+a.substr(1):a},underscore:function(a){return a.replace(A,"$1_$2").replace(B,"$1_$2").replace("-","_").toLowerCase()},singularize:function(a){return a.substr(-3)==="ies"?a.substr(0,a.length-3)+"y":a.substr(-1)==="s"?a.substr(0,a.length-1):a},pluralize:function(a,b){var c;if(b){if(a===1)return b}else b=a;c=b.substr(-1);return c==="y"?""+b.substr(0,b.length-1)+"ies":c==="s"?b:""+b+"s"},capitalize:function(a){return a.replace(s,function(a,b,c){return b+c.toUpperCase()})}},l.Property=function(){function a(a,b){this.base=a,this.key=b,this.observers=new l.SimpleSet,this.hasObserversToFire()&&this.refreshTriggers(),this._preventCount=0}a.defaultAccessor={get:function(a){return this[a]},set:function(a,b){return this[a]=b},unset:function(a){var b;b=this[a],delete this[a];return b}},a.triggerTracker=null,a.forBaseAndKey=function(a,b){var c,d,e;d=a.propertyClass||l.Keypath;if(a._batman){l.initializeObject(a),c=(e=a._batman).properties||(e.properties=new l.SimpleHash);return c.get(b)||c.set(b,new d(a,b))}return new d(a,b)},a.prototype.isProperty=!0,a.prototype.isEqual=function(a){return this.constructor===a.constructor&&this.base===a.base&&this.key===a.key},a.prototype.accessor=function(){var a,b,c,d;a=(c=this.base._batman)!=null?c.get("keyAccessors"):void 0;return a&&(b=a.get(this.key))?b:((d=this.base._batman)!=null?d.getFirst("defaultAccessor"):void 0)||l.Property.defaultAccessor},a.prototype.registerAsTrigger=function(){var a;if(a=l.Property.triggerTracker)return a.add(this)},a.prototype.getValue=function(){var a;this.registerAsTrigger();return(a=this.accessor())!=null?a.get.call(this.base,this.key):void 0},a.prototype.setValue=function(a){var b,c;this.cacheDependentValues(),b=(c=this.accessor())!=null?c.set.call(this.base,this.key,a):void 0,this.fireDependents();return b},a.prototype.unsetValue=function(){var a,b;this.cacheDependentValues(),a=(b=this.accessor())!=null?b.unset.call(this.base,this.key):void 0,this.fireDependents();return a},a.prototype.cacheDependentValues=function(){if(this.dependents)return this.dependents.forEach(function(a){return a.cachedValue=a.getValue()})},a.prototype.fireDependents=function(){if(this.dependents)return this.dependents.forEach(function(a){if(typeof a.hasObserversToFire=="function"?a.hasObserversToFire():void 0)return a.fire(a.getValue(),a.cachedValue)})},a.prototype.observe=function(){var a,b,c,d;c=2<=arguments.length?M.call(arguments,0,d=arguments.length-1):(d=0,[]),a=arguments[d++],c=c[0]===!0,b=this.getValue(),this.observers.add(a),this.refreshTriggers(),c&&a.call(this.base,b,b);return this},a.prototype.hasObserversToFire=function(){if(this.observers.length>0)return!0;return this.base._batman?this.base._batman.ancestors().some(P(function(a){var b,c;return(typeof a.property=="function"?(b=a.property(this.key))!=null?(c=b.observers)!=null?c.length:void 0:void 0:void 0)>0},this)):!1},a.prototype.prevent=function(){return this._preventCount++},a.prototype.allow=function(){if(this._preventCount>0)return this._preventCount--},a.prototype.isAllowedToFire=function(){return this._preventCount<=0},a.prototype.fire=function(){var a,b,c,d;a=1<=arguments.length?M.call(arguments,0):[];if(!!this.isAllowedToFire()&&!!this.hasObserversToFire()){c=this.key,b=this.base,d=[this.observers],this.observers.forEach(function(c){return c!=null?c.apply(b,a):void 0}),this.base._batman&&this.base._batman.ancestors(function(d){return typeof d.property=="function"?d.property(c).observers.forEach(function(c){return c!=null?c.apply(b,a):void 0}):void 0});return this.refreshTriggers()}},a.prototype.forget=function(a){a?this.observers.remove(a):this.observers=new l.SimpleSet;if(!this.hasObserversToFire())return this.clearTriggers()},a.prototype.refreshTriggers=function(){l.Property.triggerTracker=new l.SimpleSet,this.getValue(),this.triggers&&this.triggers.forEach(P(function(a){var b;if(!l.Property.triggerTracker.has(a))return(b=a.dependents)!=null?b.remove(this):void 0},this)),this.triggers=l.Property.triggerTracker,this.triggers.forEach(P(function(a){a.dependents||(a.dependents=new l.SimpleSet);return a.dependents.add(this)},this));return delete l.Property.triggerTracker},a.prototype.clearTriggers=function(){if(this.triggers){this.triggers.forEach(P(function(a){return a.dependents.remove(this)},this));return this.triggers=new l.SimpleSet}};return a}(),l.Keypath=function(){function a(b,c){j(c)==="String"?(this.segments=c.split("."),this.depth=this.segments.length):(this.segments=[c],this.depth=1),a.__super__.constructor.apply(this,arguments)}O(a,l.Property),a.prototype.slice=function(a,b){var c,d,e,f,g;b==null&&(b=this.depth),c=this.base,g=this.segments.slice(0,a);for(e=0,f=g.length;e<f;e++){d=g[e];if(c==null||!(c=l.Property.forBaseAndKey(c,d).getValue()))return}return l.Property.forBaseAndKey(c,this.segments.slice(a,b).join("."))},a.prototype.terminalProperty=function(){return this.slice(-1)},a.prototype.getValue=function(){var b;this.registerAsTrigger();return this.depth===1?a.__super__.getValue.apply(this,arguments):(b=this.terminalProperty())!=null?b.getValue():void 0},a.prototype.setValue=function(b){var c;return this.depth===1?a.__super__.setValue.apply(this,arguments):(c=this.terminalProperty())!=null?c.setValue(b):void 0},a.prototype.unsetValue=function(){var b;return this.depth===1?a.__super__.unsetValue.apply(this,arguments):(b=this.terminalProperty())!=null?b.unsetValue():void 0};return a}(),l.Observable={isObservable:!0,property:function(a){l.initializeObject(this);return l.Property.forBaseAndKey(this,a)},get:function(a){return this.property(a).getValue()},set:function(a,b){return this.property(a).setValue(b)},unset:function(a){return this.property(a).unsetValue()},getOrSet:function(a,b){var c;c=this.get(a),c||(c=b(),this.set(a,c));return c},forget:function(a,b){a?this.property(a).forget(b):this._batman.properties.forEach(function(a,b){return b.forget()});return this},allowed:function(a){return this.property(a).isAllowedToFire()}},J=["observe","prevent","allow","fire"],D=function(a){return l.Observable[a]=function(){var b,c,d;c=arguments[0],b=2<=arguments.length?M.call(arguments,1):[],(d=this.property(c))[a].apply(d,b);return this}};for(E=0,G=J.length;E<G;E++)y=J[E],D(y);f=l.get=function(a,b){return a.get?a.get(b):l.Observable.get.call(a,b)},l.EventEmitter={event:a(function(a,b,c){var e;!c&&typeof b!="undefined"&&(c=b,b=null),!c&&j(a)!=="String"&&(c=a,a=null),e=function(b){var f,g,h,i,j,k,m;!!this.observe,l.initializeObject(this),a||(a=d(e,this)),g=(k=this._batman.oneShotFired)!=null?k[a]:void 0;if(typeof b!="function"){if(this.allowed(a)){if(e.isOneShot&&g)return!1;i=c!=null?c.apply(this,arguments):void 0,i!==!1&&(e._firedArgs=typeof i!="undefined"?(m=[i]).concat.apply(m,arguments):arguments.length===0?[]:Array.prototype.slice.call(arguments),f=Array.prototype.slice.call(e._firedArgs),f.unshift(a),this.fire.apply(this,f),e.isOneShot&&(h=(j=this._batman).oneShotFired||(j.oneShotFired={}),h[a]=!0));return i}return!1}this.observe(a,b);if(e.isOneShot&&g)return b.apply(this,e._firedArgs)},b&&(e=e.bind(b)),a!=null&&(this[a]=e);return g(e,{isEvent:!0,action:c})}),eventOneShot:function(a){return g(l.EventEmitter.event.apply(this,arguments),{isOneShot:!0,oneShotFired:this.oneShotFired.bind(this)})},oneShotFired:function(a){var b,c;l.initializeObject(this),b=(c=this._batman).oneShotFired||(c.oneShotFired={});return!!b[a]}},l.event=b=function(a){var b;b=new l.Object;return b.event("_event",b,a)},l.eventOneShot=c=function(a){var b,c;b=new l.Object,c=b.eventOneShot("_event",b,a),c.oneShotFired=function(){return b.oneShotFired("_event")};return c},l.initializeObject=function(a){return a._batman!=null?a._batman.check(a):a._batman=new C(a)},l._Batman=C=function(){function a(){var a,b;b=arguments[0],a=2<=arguments.length?M.call(arguments,1):[],this.object=b,a.length>0&&g.apply(null,[this].concat(M.call(a)))}a.prototype.check=function(b){if(b!==this.object){b._batman=new a(b);return!1}return!0},a.prototype.get=function(a){var b;b=this.getAll(a);switch(b.length){case 0:return;case 1:return b[0];default:b[0].concat!=null?b=b.reduceRight(function(a,b){return a.concat(b)}):b[0].merge!=null&&(b=b.reduceRight(function(a,b){return a.merge(b)}));return b}},a.prototype.getFirst=function(a){var b;b=this.getAll(a);return b[0]},a.prototype.getAll=function(a){var b,c,d;typeof a=="function"?b=a:b=function(b){var c;return(c=b._batman)!=null?c[a]:void 0},c=this.ancestors(b),(d=b(this.object))&&c.unshift(d);return c},a.prototype.ancestors=function(a){var b,c,d,e,f,g;a==null&&(a=function(a){return a}),e=[],b=!!this.object.prototype,c=b?(g=this.object.__super__)!=null?g.constructor:void 0:(d=Object.getPrototypeOf(this.object))===this.object?this.object.constructor.__super__:d,c!=null&&(f=a(c),f!=null&&e.push(f),c._batman!=null&&(e=e.concat(c._batman.ancestors(a))));return e},a.prototype.set=function(a,b){return this[a]=b};return a}(),m=function(){function b(){var a;a=1<=arguments.length?M.call(arguments,0):[],this._batman=new C(this),this.mixin.apply(this,a)}var a;b.global=function(a){if(a!==!1)return t[e(this)]=this},b.classMixin=function(){return g.apply(null,[this].concat(M.call(arguments)))},b.mixin=function(){return this.classMixin.apply(this.prototype,arguments)},b.prototype.mixin=b.classMixin,a=function(a){!a.get&&!a.set&&!a.unset&&(a={get:a});return a},b.classAccessor=function(){var b,c,d,e,f,g,h,i;d=2<=arguments.length?M.call(arguments,0,f=arguments.length-1):(f=0,[]),b=arguments[f++],l.initializeObject(this);if(d.length===0)return this._batman.defaultAccessor=a(b);(e=this._batman).keyAccessors||(e.keyAccessors=new l.SimpleHash),i=[];for(g=0,h=d.length;g<h;g++)c=d[g],i.push(this._batman.keyAccessors.set(c,a(b)));return i},b.accessor=function(){return this.classAccessor.apply(this.prototype,arguments)},b.prototype.accessor=b.classAccessor,b.classMixin(l.Observable,l.EventEmitter),b.mixin(l.Observable,l.EventEmitter),b.observeAll=function(){return this.prototype.observe.apply(this.prototype,arguments)},b.singleton=function(a){a==null&&(a="sharedInstance");return this.classAccessor(a,{get:function(){var b;return this[b="_"+a]||(this[b]=new this)}})};return b}(),l.Object=m,l.Accessible=function(){function a(){this.accessor.apply(this,arguments)}O(a,l.Object);return a}(),l.SimpleHash=function(){function a(){this._storage={},this.length=0}a.prototype.propertyClass=l.Property,a.prototype.hasKey=function(a){var b,c,d,e,f,g;c=(e=this._storage)[a]||(e[a]=[]);for(f=0,g=c.length;f<g;f++){b=c[f];if(this.equality(b[0],a)){d=b;return!0}}return!1},a.prototype.get=function(a){var b,c,d,e,f,g;if(b=this._storage[a])for(e=0,f=b.length;e<f;e++){g=b[e],c=g[0],d=g[1];if(this.equality(c,a))return d}},a.prototype.set=function(a,b){var c,d,e,f,g,h;d=(f=this._storage)[a]||(f[a]=[]);for(g=0,h=d.length;g<h;g++){c=d[g];if(this.equality(c[0],a)){e=c;break}}e||(e=[a],d.push(e),this.length++);return e[1]=b},a.prototype.unset=function(a){var b,c,d,e,f,g;if(c=this._storage[a])for(b=0,f=c.length;b<f;b++){g=c[b],d=g[0],e=g[1];if(this.equality(d,a)){c.splice(b,1),this.length--;return}}},a.prototype.getOrSet=l.Observable.getOrSet,a.prototype.equality=function(a,b){if(a===b)return!0;if(a!==a&&b!==b)return!0;if((a!=null?typeof a.isEqual=="function"?a.isEqual(b):void 0:void 0)&&(b!=null?typeof b.isEqual=="function"?b.isEqual(a):void 0:void 0))return!0;return!1},a.prototype.forEach=function(a){var b,c,d,e,f,g;f=this._storage,g=[];for(b in f)e=f[b],g.push(function(){var b,f,g,h;h=[];for(b=0,f=e.length;b<f;b++)g=e[b],c=g[0],d=g[1],h.push(a(c,d));return h}());return g},a.prototype.keys=function(){var a;a=[],l.SimpleHash.prototype.forEach.call(this,function(b){return a.push(b)});return a},a.prototype.clear=function(){this._storage={};return this.length=0},a.prototype.isEmpty=function(){return this.length===0},a.prototype.merge=function(){var a,b,c,d,e;c=1<=arguments.length?M.call(arguments,0):[],b=new this.constructor,c.unshift(this);for(d=0,e=c.length;d<e;d++)a=c[d],a.forEach(function(a,c){return b.set(a,c)});return b};return a}(),l.Hash=function(){function e(){var a;l.SimpleHash.apply(this,arguments),this.meta=new l.Object({length:0}),a=this,this.meta.accessor("isEmpty",function(){return a.isEmpty()}),this.meta.accessor("keys",function(){return a.keys()}),e.__super__.constructor.apply(this,arguments)}var a,b,c,d;O(e,l.Object),e.prototype.propertyClass=l.Property,e.accessor({get:l.SimpleHash.prototype.get,set:function(){var a;a=l.SimpleHash.prototype.set.apply(this,arguments),this.meta.set("length",this.length);return a},unset:function(){var a;a=l.SimpleHash.prototype.unset.apply(this,arguments),this.meta.set("length",this.length);return a}}),d=["hasKey","equality","forEach","keys","isEmpty","merge"];for(b=0,c=d.length;b<c;b++)a=d[b],e.prototype[a]=l.SimpleHash.prototype[a];e.prototype.clear=function(){var a;a=l.SimpleHash.prototype.clear.apply(this,arguments),this.meta.set("length",this.length);return a};return e}(),l.SimpleSet=function(){function a(){this._storage=new l.SimpleHash,this._indexes=new l.SimpleHash,this._sorts=new l.SimpleHash,this.length=0,arguments.length>0&&this.add.apply(this,arguments)}a.prototype.has=function(a){return this._storage.hasKey(a)},a.prototype.add=function(){var a,b,c,d,e;c=1<=arguments.length?M.call(arguments,0):[],a=[];for(d=0,e=c.length;d<e;d++)b=c[d],this._storage.hasKey(b)||(this._storage.set(b,!0),a.push(b),this.length++);a.length!==0&&this.itemsWereAdded.apply(this,a);return a},a.prototype.remove=function(){var a,b,c,d,e;b=1<=arguments.length?M.call(arguments,0):[],c=[];for(d=0,e=b.length;d<e;d++)a=b[d],this._storage.hasKey(a)&&(this._storage.unset(a),c.push(a),this.length--);c.length!==0&&this.itemsWereRemoved.apply(this,c);return c},a.prototype.forEach=function(a){return this._storage.forEach(function(b,c){return a(b)})},a.prototype.isEmpty=function(){return this.length===0},a.prototype.clear=function(){var a;a=this.toArray(),this._storage=new l.SimpleHash,this.length=0,this.itemsWereRemoved.apply(this,a);return a},a.prototype.toArray=function(){return this._storage.keys()},a.prototype.merge=function(){var a,b,c,d,e;b=1<=arguments.length?M.call(arguments,0):[],a=new this.constructor,b.unshift(this);for(d=0,e=b.length;d<e;d++)c=b[d],c.forEach(function(b){return a.add(b)});return a},a.prototype.indexedBy=function(a){return this._indexes.get(a)||this._indexes.set(a,new l.SetIndex(this,a))},a.prototype.sortedBy=function(a){return this._sorts.get(a)||this._sorts.set(a,new l.SetSort(this,a))},a.prototype.itemsWereAdded=function(){},a.prototype.itemsWereRemoved=function(){};return a}(),l.Set=function(){function i(){l.SimpleSet.apply(this,arguments),this.set("length",0)}var a,b,c,d,e,f,g,h;O(i,l.Object),i.prototype.itemsWereAdded=i.event(function(){}),i.prototype.itemsWereRemoved=i.event(function(){}),g=["has","forEach","isEmpty","toArray","indexedBy","sortedBy"];for(c=0,e=g.length;c<e;c++)a=g[c],i.prototype[a]=l.SimpleSet.prototype[a];h=["add","remove","clear","merge"],b=P(function(a){return this.prototype[a]=function(){var b,c,d,e;c=this.length,this.prevent("length"),d=l.SimpleSet.prototype[a].apply(this,arguments),e=[this.length,c],b=e[0],this.length=e[1],this.allow("length"),b!==c&&this.set("length",b);return d}},i);for(d=0,f=h.length;d<f;d++)a=h[d],b(a);i.accessor("indexedBy",function(){return new l.Accessible(P(function(a){return this.indexedBy(a)},this))}),i.accessor("sortedBy",function(){return new l.Accessible(P(function(a){return this.sortedBy(a)},this))}),i.accessor("isEmpty",function(){return this.isEmpty()});return i}.call(this),l.SetObserver=function(){function a(a){this.base=a,this._itemObservers=new l.Hash,this._setObservers=new l.Hash,this._setObservers.set("itemsWereAdded",this.itemsWereAdded.bind(this)),this._setObservers.set("itemsWereRemoved",this.itemsWereRemoved.bind(this)),this.observe("itemsWereAdded",this.startObservingItems.bind(this)),this.observe("itemsWereRemoved",this.stopObservingItems.bind(this))}O(a,l.Object),a.prototype.itemsWereAdded=a.event(function(){}),a.prototype.itemsWereRemoved=a.event(function(){}),a.prototype.observedItemKeys=[],a.prototype.observerForItemAndKey=function(a,b){},a.prototype._getOrSetObserverForItemAndKey=function(a,b){return this._itemObservers.getOrSet(a,P(function(){var c;c=new l.Hash;return c.getOrSet(b,P(function(){return this.observerForItemAndKey(a,b)},this))},this))},a.prototype.startObserving=function(){this._manageItemObservers("observe");return this._manageSetObservers("observe")},a.prototype.stopObserving=function(){this._manageItemObservers("forget");return this._manageSetObservers("forget")},a.prototype.startObservingItems=function(){var a,b,c,d,e;b=1<=arguments.length?M.call(arguments,0):[],e=[];for(c=0,d=b.length;c<d;c++)a=b[c],e.push(this._manageObserversForItem(a,"observe"));return e},a.prototype.stopObservingItems=function(){var a,b,c,d,e;b=1<=arguments.length?M.call(arguments,0):[],e=[];for(c=0,d=b.length;c<d;c++)a=b[c],e.push(this._manageObserversForItem(a,"forget"));return e},a.prototype._manageObserversForItem=function(a,b){var c,d,e,f;if(!!a.isObservable){f=this.observedItemKeys;for(d=0,e=f.length;d<e;d++)c=f[d],a[b](c,this._getOrSetObserverForItemAndKey(a,c));if(b==="forget")return this._itemObservers.unset(a)}},a.prototype._manageItemObservers=function(a){return this.base.forEach(P(function(b){return this._manageObserversForItem(b,a)},this))},a.prototype._manageSetObservers=function(a){if(!!this.base.isObservable)return this._setObservers.forEach(P(function(b,c){return this.base[a](b,c)},this))};return a}(),l.SetSort=function(){function a(a,b){var c;this.base=a,this.key=b,this.base.isObservable&&(this._setObserver=new l.SetObserver(this.base),this._setObserver.observedItemKeys=[this.key],c=this._reIndex.bind(this),this._setObserver.observerForItemAndKey=function(){return c},this._setObserver.observe("itemsWereAdded",c),this._setObserver.observe("itemsWereRemoved",c),this.startObserving()),this._reIndex()}O(a,l.Object),a.prototype.startObserving=function(){var a;return(a=this._setObserver)!=null?a.startObserving():void 0},a.prototype.stopObserving=function(){var a;return(a=this._setObserver)!=null?a.stopObserving():void 0},a.prototype.toArray=function(){return this.get("_storage")},a.accessor("toArray",a.prototype.toArray),a.prototype.forEach=function(a){var b,c,d,e,f;e=this.get("_storage"),f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(a(b,c));return f},a.prototype.compare=function(a,b){var c;if(a===b)return 0;if(a===void 0)return 1;if(b===void 0)return-1;if(a===null)return 1;if(b===null)return-1;if((typeof a.isEqual=="function"?a.isEqual(b):void 0)&&(typeof b.isEqual=="function"?b.isEqual(a):void 0))return 0;c=l.SetSort.prototype.compare(j(a),j(b));if(c!==0)return c;if(a!==a)return 1;if(b!==b)return-1;if(a>b)return 1;if(a<b)return-1;return 0},a.prototype._reIndex=function(){var a,b;a=this.base.toArray().sort(P(function(a,b){var c,d;c=l.Observable.property.call(a,this.key).getValue(),c!=null&&(c=c.valueOf()),d=l.Observable.property.call(b,this.key).getValue(),d!=null&&(d=d.valueOf());return this.compare.call(this,c,d)},this)),(b=this._setObserver)!=null&&b.startObservingItems.apply(b,a);return this.set("_storage",a)};return a}(),l.SetIndex=function(){function a(a,b){this.base=a,this.key=b,this._storage=new l.Hash,this.base.isObservable&&(this._setObserver=new l.SetObserver(this.base),this._setObserver.observedItemKeys=[this.key],this._setObserver.observerForItemAndKey=this.observerForItemAndKey.bind(this),this._setObserver.observe("itemsWereAdded",P(function(){var a,b,c,d,e;b=1<=arguments.length?M.call(arguments,0):[],e=[];for(c=0,d=b.length;c<d;c++)a=b[c],e.push(this._addItem(a));return e},this)),this._setObserver.observe("itemsWereRemoved",P(function(){var a,b,c,d,e;b=1<=arguments.length?M.call(arguments,0):[],e=[];for(c=0,d=b.length;c<d;c++)a=b[c],e.push(this._removeItem(a));return e},this))),this.base.forEach(this._addItem.bind(this)),this.startObserving()}O(a,l.Object),a.accessor(function(a){return this._resultSetForKey(a)}),a.prototype.startObserving=function(){var a;return(a=this._setObserver)!=null?a.startObserving():void 0},a.prototype.stopObserving=function(){var a;return(a=this._setObserver)!=null?a.stopObserving():void 0},a.prototype.observerForItemAndKey=function(a,b){return P(function(b,c){this._removeItemFromKey(a,c);return this._addItemToKey(a,b)},this)},a.prototype._addItem=function(a){return this._addItemToKey(a,this._keyForItem(a))},a.prototype._addItemToKey=function(a,b){return this._resultSetForKey(b).add(a)},a.prototype._removeItem=function(a){return this._removeItemFromKey(a,this._keyForItem(a))},a.prototype._removeItemFromKey=function(a,b){return this._resultSetForKey(b).remove(a)},a.prototype._resultSetForKey=function(a){return this._storage.getOrSet(a,function(){return new l.Set})},a.prototype._keyForItem=function(a){return l.Keypath.forBaseAndKey(a,this.key).getValue()};return a}(),l.UniqueSetIndex=function(){function a(){this._uniqueIndex=new l.Hash,a.__super__.constructor.apply(this,arguments)}O(a,l.SetIndex),a.accessor(function(a){return this._uniqueIndex.get(a)}),a.prototype._addItemToKey=function(a,b){this._resultSetForKey(b).add(a);if(!this._uniqueIndex.hasKey(b))return this._uniqueIndex.set(b,a)},a.prototype._removeItemFromKey=function(a,b){var c;c=this._resultSetForKey(b),c.remove(a);return c.length===0?this._uniqueIndex.unset(b):this._uniqueIndex.set(b,c.toArray()[0])};return a}(),l.SortableSet=function(){function f(){f.__super__.constructor.apply(this,arguments),this._sortIndexes={},this.observe("activeIndex",P(function(){return this.setWasSorted(this)},this))}var a,b,c,d,e;O(f,l.Set),f.prototype.setWasSorted=f.event(function(){if(this.length===0)return!1}),e=["add","remove","clear"],b=P(function(a){return this.prototype[a]=function(){var b;b=l.Set.prototype[a].apply(this,arguments),this._reIndex();return b}},f);for(c=0,d=e.length;c<d;c++)a=e[c],b(a);f.prototype.addIndex=function(a){return this._reIndex(a)},f.prototype.removeIndex=function(a){this._sortIndexes[a]=null,delete this._sortIndexes[a],this.activeIndex===a&&this.unset("activeIndex");return a},f.prototype.forEach=function(a){var b,c,d,e,f;e=this.toArray(),f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(a(b));return f},f.prototype.sortBy=function(a){this._sortIndexes[a]||this.addIndex(a),this.activeIndex!==a&&this.set("activeIndex",a);return this},f.prototype.isSorted=function(){return this._sortIndexes[this.get("activeIndex")]!=null},f.prototype.toArray=function(){return this._sortIndexes[this.get("activeIndex")]||f.__super__.toArray.apply(this,arguments)},f.prototype._reIndex=function(a){var b,c,d,e;if(a)e=a.split(" "),c=e[0],d=e[1],b=l.Set.prototype.toArray.call(this),this._sortIndexes[a]=b.sort(function(a,b){var e,f,g,h,i;e=(g=l.Observable.property.call(a,c).getValue())!=null?g.valueOf():void 0,f=(h=l.Observable.property.call(b,c).getValue())!=null?h.valueOf():void 0,(d!=null?d.toLowerCase():void 0)==="desc"&&(i=[f,e],e=i[0],f=i[1]);return e<f?-1:e>f?1:0}),this.activeIndex===a&&this.setWasSorted(this);else{for(a in this._sortIndexes)this._reIndex(a);this.setWasSorted(this)}return this};return f}.call(this),l.StateMachine={initialize:function(){l.initializeObject(this);if(!this._batman.states)return this._batman.states=new l.SimpleHash},state:function(a,b){var c;l.StateMachine.initialize.call(this);if(!a)return this._batman.getFirst("state");c=this[a]||this.event(a,function(){L.call(this,a);return!1}),typeof b=="function"&&c.call(this,b);return c},transition:function(a,c,d){var e,f,g;l.StateMachine.initialize.call(this),this.state(a),this.state(c),f=""+a+"->"+c,g=this._batman.states,e=g.get(f)||g.set(f,b(function(){})),d&&e(d);return e}},l.Object.actsAsStateMachine=function(a){a==null&&(a=!0),l.StateMachine.initialize.call(this),l.StateMachine.initialize.call(this.prototype),this.classState=function(){return l.StateMachine.state.apply(this,arguments)},this.state=function(){return this.classState.apply(this.prototype,arguments)},a&&(this.prototype.state=this.classState),this.classTransition=function(){return l.StateMachine.transition.apply(this,arguments)},this.transition=function(){return this.classTransition.apply(this.prototype,arguments)};if(a)return this.prototype.transition=this.classTransition},L=function(a){var b,c,d,e,f,g,h,i;l.StateMachine.initialize.call(this);if(this._batman.isTransitioning){((e=this._batman).nextState||(e.nextState=[])).push(a);return!1}this._batman.isTransitioning=!0,d=this.state(),this._batman.state=a;if(a&&d){c=""+d+"->"+a,h=this._batman.getAll(function(a){var b,d;return(b=a._batman)!=null?(d=b.get("states"))!=null?d.get(c):void 0:void 0});for(f=0,g=h.length;f<g;f++)b=h[f],b&&b(a,d)}a&&this.fire(a,a,d),this._batman.isTransitioning=!1,((i=this._batman.nextState)!=null?i.length:void 0)&&this[this._batman.nextState.shift()]();return a},l.Request=function(){function a(){a.__super__.constructor.apply(this,arguments)}O(a,l.Object),a.prototype.url="",a.prototype.data="",a.prototype.method="get",a.prototype.response=null,a.prototype.status=null,a.prototype.contentType="application/x-www-form-urlencoded",a.observeAll("url",function(){return this._autosendTimeout=setTimeout(P(function(){return this.send()},this),0)}),a.prototype.loading=a.event(function(){}),a.prototype.loaded=a.event(function(){}),a.prototype.success=a.event(function(){}),a.prototype.error=a.event(function(){}),a.prototype.send=function(){},a.prototype.cancel=function(){if(this._autosendTimeout)return clearTimeout(this._autosendTimeout)};return a}(),l.App=function(){function a(){a.__super__.constructor.apply(this,arguments)}O(a,l.Object),a.requirePath="",a.require=function(){var a,b,c,d,e,f;d=arguments[0],c=2<=arguments.length?M.call(arguments,1):[],a=this.requirePath+d;for(e=0,f=c.length;e<f;e++)b=c[e],this.prevent("run"),d=a+"/"+b+".coffee",new l.Request({url:d,type:"html",success:P(function(a){CoffeeScript.eval(a),this.allow("run");return this.run()},this)});return this},a.controller=function(){var a;a=1<=arguments.length?M.call(arguments,0):[],a=a.map(function(a){return a+"_controller"});return this.require.apply(this,["controllers"].concat(M.call(a)))},a.model=function(){return this.require.apply(this,["models"].concat(M.call(arguments)))},a.view=function(){return this.require.apply(this,["views"].concat(M.call(arguments)))},a.layout=void 0,a.run=a.eventOneShot(function(){if(l.currentApp){if(l.currentApp===this)return;l.currentApp.stop()}if(this.hasRun)return!1;l.currentApp=this,typeof this.dispatcher=="undefined"&&(this.dispatcher||(this.dispatcher=new l.Dispatcher(this))),typeof this.layout=="undefined"&&(this.set("layout",new l.View({contexts:[this],node:document})),this.get("layout").ready(P(function(){return this.ready()},this))),typeof this.historyManager=="undefined"&&this.dispatcher.routeMap&&(this.historyManager=l.historyManager=new l.HashHistory(this),this.historyManager.start()),this.hasRun=!0;return this}),a.ready=a.eventOneShot(function(){return!0}),a.stop=a.eventOneShot(function(){var a;(a=this.historyManager)!=null&&a.stop(),l.historyManager=null,this.hasRun=!1;return this});return a}(),l.Route=function(){function f(){var g;f.__super__.constructor.apply(this,arguments),this.pattern=this.url.replace(a,"\\$&"),this.regexp=new RegExp("^"+this.pattern.replace(c,"([^/]*)").replace(e,"(.*?)")+d+"$"),this.namedArguments=[];while((g=b.exec(this.pattern))!=null)g[1]&&this.namedArguments.push(g[1])}var a,b,c,d,e;O(f,l.Object),c=/:([\w\d]+)/g,e=/\*([\w\d]+)/g,d="(?:\\?.+)?",b=/[:|\*]([\w\d]+)/g,a=/[-[\]{}()+?.,\\^$|#\s]/g,f.accessor("action",{get:function(){var a,b,c;if(this.action)return this.action;if(this.options){b=g({},this.options);if(c=b.signature)a=c.split("#"),b.controller=a[0],b.action=a[1]||"index";b.target=this.dispatcher.get(b.controller);return this.set("action",b)}},set:function(a,b){return this.action=b}}),f.prototype.parameterize=function(a){var b,c,d,e,f,h,i,j,k,l,m,n,o,p,q,r;o=a.split("?"),a=o[0],i=o[1],c=(p=this.regexp.exec(a))!=null?p.slice(1):void 0,h={url:a},b=this.get("action"),typeof b=="function"?h.action=b:g(h,b);if(c)for(d=0,m=c.length;d<m;d++)f=c[d],h[this.namedArguments[d]]=f;if(i){q=i.split("&");for(l=0,n=q.length;l<n;l++)j=q[l],r=j.split("="),e=r[0],k=r[1],h[e]=k}return h},f.prototype.dispatch=function(a){var b,c,d,e;j(a)==="String"&&(c=this.parameterize(a)),!(b=c.action)&&a!=="/404"&&i("/404");if(typeof b=="function")return b(c);if((d=c.target)!=null?d.dispatch:void 0)return c.target.dispatch(b,c);return(e=c.target)!=null?e[b](c):void 0};return f}(),l.Dispatcher=function(){function a(a){var b,c,d;this.app=a,this.app.route(this),this.app.controllers=new l.Object,d=this.app;for(c in d){b=d[c];if(!((b!=null?b.prototype:void 0)instanceof l.Controller))continue;this.prepareController(b)}}O(a,l.Object),a.prototype.prepareController=function(a){var b,c;c=w.underscore(e(a).replace("Controller",""));if(!!c){b=function(){return this[c]=a.get("sharedController")},this.accessor(c,b);return this.app.controllers.accessor(c,b)}},a.prototype.register=function(a,b){var c;a.indexOf("/")!==0&&(a="/"+a),c=j(b)==="Function"?new l.Route({url:a,action:b,dispatcher:this}):new l.Route({url:a,options:b,dispatcher:this}),this.routeMap||(this.routeMap={});return this.routeMap[a]=c},a.prototype.findRoute=function(a){var b,c,d;a.indexOf("/")!==0&&(a="/"+a);if(b=this.routeMap[a])return b;d=this.routeMap;for(c in d){b=d[c];if(b.regexp.test(a))return b}},a.prototype.findUrl=function(a){var b,c,d,e,f,g,h,i,j,k;j=this.routeMap;for(h in j){g=j[h],e=!1,f=g.options;if(a.resource)e=f.resource===a.resource&&f.action===a.action;else{b=g.get("action");if(typeof b=="function")continue;k=b,c=k.controller,b=k.action,c===a.controller&&b===(a.action||"index")&&(e=!0)}if(!e)continue;for(d in a)i=a[d],h=h.replace(new RegExp("[:|*]"+d),i);return h}},a.prototype.dispatch=function(a){var b;b=this.findRoute(a),b?b.dispatch(a):a!=="/404"&&i("/404");return this.app.set("currentURL",a)};return a}(),l.HistoryManager=function(){function a(a){this.app=a}a.prototype.dispatch=function(a){a.indexOf("/")!==0&&(a="/"+a),this.app.dispatcher.dispatch(a);return a},a.prototype.redirect=function(a){j(a)!=="String"&&(a=this.app.dispatcher.findUrl(a));return this.dispatch(a)};return a}(),l.HashHistory=function(){function a(){this.parseHash=P(this.parseHash,this),this.stop=P(this.stop,this),this.start=P(this.start,this),a.__super__.constructor.apply(this,arguments)}O(a,l.HistoryManager),a.prototype.HASH_PREFIX="#!",a.prototype.start=function(){if(typeof window!="undefined"){if(this.started)return;this.started=!0,"onhashchange"in window?l.DOM.addEventListener(window,"hashchange",this.parseHash):this.interval=setInterval(this.parseHash,100),this.first=!0,l.currentApp.prevent("ready");return setTimeout(this.parseHash,0)}},a.prototype.stop=function(){this.interval?this.interval=clearInterval(this.interval):window.removeEventListener("hashchange",this.parseHash,!1);return this.started=!1},a.prototype.urlFor=function(a){return this.HASH_PREFIX+a},a.prototype.parseHash=function(){var a,b;a=window.location.hash.replace(this.HASH_PREFIX,"");if(a!==this.cachedHash){b=this.dispatch(this.cachedHash=a),this.first&&(l.currentApp.allow("ready"),l.currentApp.fire("ready"),this.first=!1);return b}},a.prototype.redirect=function(b){var c;c=a.__super__.redirect.apply(this,arguments),this.cachedHash=c;return window.location.hash=this.HASH_PREFIX+c};return a}(),l.redirect=i=function(a){var b;return(b=l.historyManager)!=null?b.redirect(a):void 0},l.App.classMixin({route:function(a,b,c){var d,e,f,h;c==null&&(c={});if(!!a){if(a instanceof l.Dispatcher){d=a,h=this._dispatcherCache;for(e in h)f=h[e],d.register(e,f);this._dispatcherCache=null;return d}j(b)==="String"?c.signature=b:j(b)==="Function"?c=b:b&&g(c,b),this._dispatcherCache||(this._dispatcherCache={});return this._dispatcherCache[a]=c}},root:function(a,b){return this.route("/",a,b)},resources:function(a,b,c){var d,e,f;typeof b=="function"&&(c=b,b=null),a=w.pluralize(a),e=(b!=null?b.controller:void 0)||a,this.route(a,""+e+"#index",{resource:e,action:"index"}),this.route(""+a+"/:id",""+e+"#show",{resource:e,action:"show"}),this.route(""+a+"/:id/edit",""+e+"#edit",{resource:e,action:"edit"}),this.route(""+a+"/:id/destroy",""+e+"#destroy",{resource:e,action:"destroy"});if(c){d=this,f={collection:function(b){return b!=null?b.call({route:function(b,c){return d.route(""+a+"/"+b,""+e+"#"+(c||b))}}):void 0},member:function(b){return b!=null?b.call({route:function(b,c){return d.route(""+a+"/:id/"+b,""+e+"#"+(c||b))}}):void 0}};return c.call(f)}},redirect:i}),l.Controller=function(){function a(){this.redirect=P(this.redirect,this),a.__super__.constructor.apply(this,arguments)}O(a,l.Object),a.singleton("sharedController"),a.beforeFilter=function(a){var b,c;l.initializeObject(this),b=(c=this._batman).beforeFilters||(c.beforeFilters=[]);if(b.indexOf(a)===-1)return b.push(a)},a.accessor("controllerName",{get:function(){return this._controllerName||(this._controllerName=w.underscore(e(this.constructor).replace("Controller","")))}}),a.accessor("action",{get:function(){return this._currentAction},set:function(a,b){return this._currentAction=b}}),a.prototype.dispatch=function(a,b){var c,d,e,f,g,h,j,k,m,n,o,p,q;b==null&&(b={}),b.controller||(b.controller=this.get("controllerName")),b.action||(b.action=a),b.target||(b.target=this),e=(m=l.historyManager)!=null?m.redirect:void 0,(n=l.historyManager)!=null&&(n.redirect=this.redirect),this._actedDuringAction=!1,this.set("action",a);if(d=(o=this.constructor._batman)!=null?o.get("beforeFilters"):void 0)for(g=0,j=d.length;g<j;g++)c=d[g],typeof c=="function"?c.call(this,b):this[c](b);this[a](b),this._actedDuringAction||this.render();if(d=(p=this.constructor._batman)!=null?p.get("afterFilters"):void 0)for(h=0,k=d.length;h<k;h++)c=d[h],typeof c=="function"?c.call(this,b):this[c](b);delete this._actedDuringAction,this.set("action",null),(q=l.historyManager)!=null&&(q.redirect=e),f=this._afterFilterRedirect,delete this._afterFilterRedirect;if(f)return i(f)},a.prototype.redirect=function(a){if(this._actedDuringAction)throw"DoubleRedirectError";if(this.get("action")){this._actedDuringAction=!0;return this._afterFilterRedirect=a}j(a)==="Object"&&(a.controller||(a.controller=this));return i(a)},a.prototype.render=function(a){var b,c;a==null&&(a={});if(this._actedDuringAction)throw"DoubleRenderError";this._actedDuringAction=!0;if(a!==!1){a.view||(a.source||(a.source=w.underscore(e(this.constructor).replace("Controller",""))+"/"+this._currentAction+".html"),a.view=new l.View(a));if(b=a.view)(c=l.currentApp)!=null&&c.prevent("ready"),b.contexts.push(this),b.ready(function(){var a,c;l.DOM.contentFor("main",b.get("node")),(a=l.currentApp)!=null&&a.allow("ready");return(c=l.currentApp)!=null?c.fire("ready"):void 0});return b}};return a}(),l.Model=function(){function i(a){a==null&&(a={}),this.destroy=P(this.destroy,this),this.save=P(this.save,this),this.load=P(this.load,this),this.dirtyKeys=new l.Hash,this.errors=new l.ErrorsHash,j(a)==="Object"?i.__super__.constructor.call(this,a):(i.__super__.constructor.call(this),this.set("id",a)),this.state()||this.empty()}var a,b,c,d,f,g,h;O(i,l.Object),i.primaryKey="id",i.storageKey=null,i.persist=function(){var a,b,c,d,e;b=1<=arguments.length?M.call(arguments,0):[],l.initializeObject(this.prototype),d=(e=this.prototype._batman).storage||(e.storage=[]),c=function(){var c,e,f;f=[];for(c=0,e=b.length;c<e;c++)a=b[c],a=a.isStorageAdapter?a:new a(this),d.push(a),f.push(a);return f}.call(this);return c.length>1?c:c[0]},i.encode=function(){var a,b,c,d,e,f,g,h,i,k,m;e=2<=arguments.length?M.call(arguments,0,h=arguments.length-1):(h=0,[]),c=arguments[h++],l.initializeObject(this.prototype),(f=this.prototype._batman).encoders||(f.encoders=new l.SimpleHash),(g=this.prototype._batman).decoders||(g.decoders=new l.SimpleHash);switch(j(c)){case"String":e.push(c);break;case"Function":b=c;break;default:b=c.encode,a=c.decode}m=[];for(i=0,k=e.length;i<k;i++)d=e[i],this.prototype._batman.encoders.set(d,b||this.defaultEncoder.encode),m.push(this.prototype._batman.decoders.set(d,a||this.defaultEncoder.decode));return m},i.defaultEncoder={encode:function(a){return a},decode:function(a){return a}},i.observe("primaryKey",!0,function(a){return this.encode(a,this.defaultEncoder)}),i.validate=function(){var a,b,c,d,e,f,g,h,i,j,k,m;a=2<=arguments.length?M.call(arguments,0,i=arguments.length-1):(i=0,[]),e=arguments[i++],l.initializeObject(this.prototype),g=(h=this.prototype._batman).validators||(h.validators=[]);if(typeof e=="function")return g.push({keys:a,callback:e});d=e,m=[];for(j=0,k=p.length;j<k;j++)f=p[j],m.push(function(){var e,h;if(c=f.matches(d)){for(e=0,h=c.length;e<h;e++)b=c[e],delete d[b];return g.push({keys:a,validator:new f(c)})}}());return m},i.classAccessor("all",{get:function(){var a;this.prototype.hasStorage()&&(a=this.classState())!=="loaded"&&a!=="loading"&&this.load();return this.get("loaded")},set:function(a,b){return this.set("loaded",b)}}),i.classAccessor("loaded",{get:function(){this.all||(this.all=new l.SortableSet,this.all.sortBy("id asc"));return this.all},set:function(a,b){return this.all=b}}),i.classAccessor("first",function(){return this.get("all").toArray()[0]}),i.classAccessor("last",function(){var a;a=this.get("all").toArray();return a[a.length-1]}),i.find=function(a,b){var c,d;d=new this(a),c=this._mapIdentity(d),c.load(b)},i.load=function(a,b){j(a)==="Function"&&(b=a,a={}),this.loading();return this.prototype._doStorageOperation("readAll",a,P(function(a,c){var d,e;if(a!=null)return typeof b=="function"?b(a,[]):void 0;d=function(){var a,b,d;d=[];for(a=0,b=c.length;a<b;a++)e=c[a],d.push(this._mapIdentity(e));return d}.call(this),this.loaded();return typeof b=="function"?b(a,d):void 0},this))},i.create=function(a,b){var c,d;b||(d=[{},a],a=d[0],b=d[1]),c=new this(a),c.save(b);return c},i.findOrCreate=function(a,b){var c,d;d=new this(a);if(d.isNew())return d.save(b);c=this._mapIdentity(d),c.updateAttributes(a);return b(void 0,c)},i._mapIdentity=function(a){var b,c,d;if(typeof (c=a.get("id"))=="undefined"||c==="")return a;b=(d=this.get("loaded.indexedBy.id").get(c))!=null?d.toArray()[0]:void 0;if(b)return b;this.get("loaded").add(a);return a},i.accessor("id",{get:function(){var a;a=this.constructor.get("primaryKey");return a==="id"?this.id:this.get(a)},set:function(a,b){var c;c=this.constructor.get("primaryKey");return c==="id"?this.id=b:this.set(c,b)}}),i.accessor("dirtyKeys","errors",l.Property.defaultAccessor),i.accessor("batmanState",{get:function(){return this.state()},set:function(a,b){return this.state(b)}}),i.accessor({get:function(a){var b;return((b=this._batman).attributes||(b.attributes={}))[a]||this[a]},set:function(a,b){var c;return((c=this._batman).attributes||(c.attributes={}))[a]=b},unset:function(a){var b,c;b=((c=this._batman).attributes||(c.attributes={}))[a],delete this._batman.attributes[a];return b}}),i.prototype.set=function(a,b){var c,d,e;c=this.get(a);if(c!==b){d=i.__super__.set.apply(this,arguments),this.dirtyKeys.set(a,c),(e=this.state())!=="dirty"&&e!=="loading"&&e!=="creating"&&this.dirty();return d}},i.prototype.updateAttributes=function(a){this.mixin(a);return this},i.prototype.toString=function(){return""+e(this.constructor)+": "+this.get("id")},i.prototype.toJSON=function(){var a,b;b={},a=this._batman.get("encoders"),!!a&&!a.isEmpty()&&a.forEach(P(function(a,c){var d,e;e=this.get(a);if(typeof e!="undefined"){d=c(this.get(a));if(typeof d!="undefined")return b[a]=d}},this));return b},i.prototype.fromJSON=function(a){var b,c,d,e;d={},b=this._batman.get("decoders");if(!b||b.isEmpty())for(c in a)e=a[c],d[c]=e;else b.forEach(function(b,c){if(a[b])return d[b]=c(a[b])});return this.mixin(d)},i.actsAsStateMachine(!0),g=["empty","dirty","loading","loaded","saving","saved","creating","created","validating","validated","destroying","destroyed"];for(b=0,d=g.length;b<d;b++)a=g[b],i.state(a);h=["loading","loaded"];for(c=0,f=h.length;c<f;c++)a=h[c],i.classState(a);i.prototype._doStorageOperation=function(a,b,c){var d,e,f,g;e=this._batman.get("storage");for(f=0,g=e.length;f<g;f++)d=e[f],d[a](this,b,c);return!0},i.prototype.hasStorage=function(){return(this._batman.get("storage")||[]).length>0},i.prototype.load=function(a){var b;if((b=this.state())==="destroying"||b==="destroyed")typeof a=="function"&&a(new Error("Can't load a destroyed record!"));else{this.loading();return this._doStorageOperation("read",{},P(function(b,c){b||(this.loaded(),c=this.constructor._mapIdentity(c));return typeof a=="function"?a(b,c):void 0},this))}},i.prototype.save=function(a){var b;if((b=this.state())==="destroying"||b==="destroyed")typeof a=="function"&&a(new Error("Can't save a destroyed record!"));else return this.validate(P(function(b,c){var d;if(!b)typeof a=="function"&&a(c);else{d=this.isNew(),this.saving(),d&&this.creating();return this._doStorageOperation(d?"create":"update",{},P(function(b,c){b||(d&&this.created(),this.saved(),this.dirtyKeys.clear(),c=this.constructor._mapIdentity(c));return typeof a=="function"?a(b,c):void 0},this))}},this))},i.prototype.destroy=function(a){this.destroying();return this._doStorageOperation("destroy",{},P(function(b,c){b||(this.constructor.get("all").remove(this),this.destroyed());return typeof a=="function"?a(b):void 0},this))},i.prototype.validate=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n;e=this.state(),this.errors.clear(),this.validating(),c=P(function(){this.validated(),this[e]();return typeof a=="function"?a(this.errors.length===0,this.errors):void 0},this),i=this._batman.get("validators")||[];if(i.length>0){b=i.length,g=P(function(){if(--b===0)return c()},this);for(j=0,k=i.length;j<k;j++){h=i[j],f=h.validator,n=h.keys;for(m=0,l=n.length;m<l;m++)d=n[m],f?f.validateEach(this.errors,this,d,g):h.callback(this.errors,this,d,g)}}else c()},i.prototype.isNew=function(){return typeof this.get("id")=="undefined"};return i}(),l.ErrorsHash=function(){function a(){a.__super__.constructor.apply(this,arguments),this.meta.observe("length",P(function(a){return this.length=a},this)),this.meta.set("messages",new l.Set)}O(a,l.Hash),a.accessor({get:function(a){var b;(b=l.SimpleHash.prototype.get.call(this,a))||(b=new l.Set,b.observe("itemsWereAdded",P(function(){var a,b;a=1<=arguments.length?M.call(arguments,0):[],this.meta.set("length",this.meta.get("length")+a.length);return(b=this.meta.get("messages")).add.apply(b,a)},this)),b.observe("itemsWereRemoved",P(function(){var a,b;a=1<=arguments.length?M.call(arguments,0):[],this.meta.set("length",this.meta.get("length")-arguments.length);return(b=this.meta.get("messages")).remove.apply(b,a)},this)),l.SimpleHash.prototype.set.call(this,a,b));return b},set:function(){},unset:function(){}}),a.prototype.add=function(a,b){return this.get(a).add(b)},a.prototype.clear=function(){this.forEach(function(a,b){return b.clear()});return this};return a}(),l.Validator=function(){function a(){var b,c;c=arguments[0],b=2<=arguments.length?M.call(arguments,1):[],this.options=c,a.__super__.constructor.apply(this,b)}O(a,l.Object),a.prototype.validate=function(a){},a.options=function(){var a;a=1<=arguments.length?M.call(arguments,0):[],l.initializeObject(this);return this._batman.options?this._batman.options.concat(a):this._batman.options=a},a.matches=function(a){var b,c,d,e,f,g;c={},d=!1;for(b in a)e=a[b],~((f=this._batman)!=null?(g=f.options)!=null?g.indexOf(b):void 0:void 0)&&(c[b]=e,d=!0);if(d)return c};return a}(),p=l.Validators=[l.LengthValidator=function(){function a(b){var c;if(c=b.lengthIn||b.lengthWithin)b.minLength=c[0],b.maxLength=c[1]||-1,delete b.lengthWithin,delete b.lengthIn;a.__super__.constructor.apply(this,arguments)}O(a,l.Validator),a.options("minLength","maxLength","length","lengthWithin","lengthIn"),a.prototype.validateEach=function(a,b,c,d){var e,f;e=this.options,f=b.get(c),e.minLength&&f.length<e.minLength&&a.add(c,""+c+" must be at least "+e.minLength+" characters"),e.maxLength&&f.length>e.maxLength&&a.add(c,""+c+" must be less than "+e.maxLength+" characters"),e.length&&f.length!==e.length&&a.add(c,""+c+" must be "+e.length+" characters");return d()};return a}(),l.PresenceValidator=function(){function a(){a.__super__.constructor.apply(this,arguments)}O(a,l.Validator),a.options("presence"),a.prototype.validateEach=function(a,b,c,d){var e;e=b.get(c),this.options.presence&&e==null&&a.add(c,""+c+" must be present");return d()};return a}()],l.StorageAdapter=function(){function k(a){k.__super__.constructor.call(this,{model:a,modelKey:a.get("storageKey")||w.pluralize(w.underscore(e(a)))})}var a,b,c,d,f,g,h,i,j;O(k,l.Object),k.prototype.isStorageAdapter=!0,k.prototype._batman.check(k.prototype),i=["all","create","read","readAll","update","destroy"];for(d=0,g=i.length;d<g;d++){a=i[d],j=["before","after"],c=P(function(a,b){var c;c=""+b+w.capitalize(a);return this.prototype[c]=function(a){var b,d;this._batman.check(this);return((b=this._batman)[d=""+c+"Filters"]||(b[d]=[])).push(a)}},k);for(f=0,h=j.length;f<h;f++)b=j[f],c(a,b)}k.prototype.before=function(){var a,b,c,d,e,f,g;c=2<=arguments.length?M.call(arguments,0,d=arguments.length-1):(d=0,[]),a=arguments[d++],g=[];for(f=0,e=c.length;f<e;f++)b=c[f],g.push(this["before"+w.capitalize(b)](a));return g},k.prototype.after=function(){var a,b,c,d,e,f,g;c=2<=arguments.length?M.call(arguments,0,d=arguments.length-1):(d=0,[]),a=arguments[d++],g=[];for(f=0,e=c.length;f<e;f++)b=c[f],g.push(this["after"+w.capitalize(b)](a));return g},k.prototype._filterData=function(){var a,b,c;c=arguments[0],a=arguments[1],b=3<=arguments.length?M.call(arguments,2):[];return(this._batman.get(""+c+w.capitalize(a)+"Filters")||[]).concat(this._batman.get(""+c+"AllFilters")||[]).reduce(P(function(a,b){return b.call(this,a)},this),b)},k.prototype.getRecordFromData=function(a){var b;b=new this.model,b.fromJSON(a);return b};return k}.call(this),h=function(a){return function(b){var c;if(b[0])return b;c=b.shift(),b=a.call(this,b),b.unshift(c);return b}},l.LocalStorage=function(){function a(){if(typeof window.localStorage=="undefined")return null;a.__super__.constructor.apply(this,arguments),this.storage=localStorage,this.key_re=new RegExp("^"+this.modelKey+"(\\d+)$"),this.nextId=1,this._forAllRecords(function(a,b){var c;if(c=this.key_re.exec(a))return this.nextId=Math.max(this.nextId,parseInt(c[1],10)+1)});return}O(a,l.StorageAdapter),a.prototype.before("create","update",h(function(a){var b,c;c=a[0],b=a[1];return[JSON.stringify(c),b]})),a.prototype.after("read",h(function(a){var b,c,d;d=a[0],b=a[1],c=a[2];return[d.fromJSON(JSON.parse(b)),b,c]})),a.prototype._forAllRecords=function(a){var b,c,d;d=[];for(b=0,c=this.storage.length;0<=c?b<c:b>c;0<=c?b++:b--)y=this.storage.key(b),d.push(a.call(this,y,this.storage.getItem(y)));return d},a.prototype.getRecordFromData=function(b){var c;c=a.__super__.getRecordFromData.apply(this,arguments),this.nextId=Math.max(this.nextId,parseInt(c.get("id"),10)+1);return c},a.prototype.update=function(a,b,c){var d,e,f,g;g=this._filterData("before","update",void 0,a,b),d=g[0],f=g[1],d||(e=a.get("id"),e!=null?this.storage.setItem(this.modelKey+e,f):d=new Error("Couldn't get record primary key."));return c.apply(null,this._filterData("after","update",d,a,b))},a.prototype.create=function(a,b,c){var d,e,f,g,h;h=this._filterData("before","create",void 0,a,b),d=h[0],g=h[1],d||(e=a.get("id")||a.set("id",this.nextId++),e!=null?(f=this.modelKey+e,this.storage.getItem(f)?d=new Error("Can't create because the record already exists!"):this.storage.setItem(f,g)):d=new Error("Couldn't set record primary key on create!"));return c.apply(null,this._filterData("after","create",d,a,b))},a.prototype.read=function(a,b,c){var d,e,f,g;g=this._filterData("before","read",void 0,a,b),e=g[0],a=g[1],f=a.get("id"),e||(f!=null?(d=this.storage.getItem(this.modelKey+f),d||(e=new Error("Couldn't find record!"))):e=new Error("Couldn't get record primary key."));return c.apply(null,this._filterData("after","read",e,a,d,b))},a.prototype.readAll=function(a,b,c){var d,e,f;e=[],f=this._filterData("before","readAll",void 0,b),d=f[0],b=f[1],d||this._forAllRecords(function(a,b){var c;if(c=this.key_re.exec(a))return e.push({data:b,id:c[1]})});return c.apply(null,this._filterData("after","readAll",d,e,b))},a.prototype.after("readAll",h(function(a){var b,c,d,e;b=a[0],e=a[1],b=function(){var a,e,f,g;g=[];for(a=0,e=b.length;a<e;a++)c=b[a],d=JSON.parse(c.data),d[f=this.model.primaryKey]||(d[f]=parseInt(c.id,10)),g.push(d);return g}.call(this);return[b,e]})),a.prototype.after("readAll",h(function(a){var b,c,d,e,f,g,h,i,j;b=a[0],g=a[1],f=[];for(i=0,j=b.length;i<j;i++){c=b[i],e=!0;for(d in g){h=g[d];if(c[d]!==h){e=!1;break}}e&&f.push(c)}return[f,g]})),a.prototype.after("readAll",h(function(a){var b,c,d;c=a[0],d=a[1];return[function(){var a,d,e;e=[];for(a=0,d=c.length;a<d;a++)b=c[a],e.push(this.getRecordFromData(b));return e}.call(this),c,d]})),a.prototype.destroy=function(a,b,c){var d,e,f,g;g=this._filterData("before","destroy",void 0,a,b),d=g[0],a=g[1],d||(e=a.get("id"),e!=null?(f=this.modelKey+e,this.storage.getItem(f)?this.storage.removeItem(f):d=new Error("Can't delete nonexistant record!")):d=new Error("Can't delete record without an primary key!"));return c.apply(null,this._filterData("after","destroy",d,a,b))};return a}(),l.RestStorage=function(){function a(){a.__super__.constructor.apply(this,arguments),this.recordJsonNamespace=w.singularize(this.modelKey),this.collectionJsonNamespace=w.pluralize(this.modelKey),this.model.encode("id")}O(a,l.StorageAdapter),a.prototype.defaultOptions={type:"json"},a.prototype.recordJsonNamespace=!1,a.prototype.collectionJsonNamespace=!1,a.prototype.before("create","update",h(function(a){var b,c,d,e;d=a[0],c=a[1],b=d.toJSON(),d=this.recordJsonNamespace?(e={},e[this.recordJsonNamespace]=b,e):b;return[d,c]})),a.prototype.after("create","read","update",h(function(a){var b,c,d;d=a[0],b=a[1],c=a[2],b[this.recordJsonNamespace]&&(b=b[this.recordJsonNamespace]);return[d,b,c]})),a.prototype.after("create","read","update",h(function(a){var b,c,d;d=a[0],b=a[1],c=a[2],d.fromJSON(b);return[d,b,c]})),a.prototype.optionsForRecord=function(a,b,c){var d,e;if(a.url)e=typeof a.url=="function"?a.url():a.url;else{e="/"+this.modelKey;if(b||!a.isNew()){d=a.get("id");if(d==null){c.call(this,new Error("Couldn't get record primary key!"));return}e=e+"/"+d}}return e?c.call(this,void 0,g({},this.defaultOptions,{url:e})):c.call(this,new Error("Couldn't get model url!"))},a.prototype.optionsForCollection=function(a,b){var c,d;c=(typeof (d=this.model).url=="function"?d.url():void 0)||this.model.url||"/"+this.modelKey;return c?b.call(this,void 0,g({},this.defaultOptions,{url:c,data:g({},this.defaultOptions.data,a)})):b.call(this,new Error("Couldn't get collection url!"))},a.prototype.create=function(a,b,c){return this.optionsForRecord(a,!1,function(d,e){var f,h;h=this._filterData("before","create",d,a,b),d=h[0],f=h[1];if(d)c(d);else return new l.Request(g(e,{data:f,method:"POST",success:P(function(d){return c.apply(null,this._filterData("after","create",void 0,a,d,b))},this),error:P(function(d){return c.apply(null,this._filterData("after","create",d,a,d.request.get("response"),b))},this)}))})},a.prototype.update=function(a,b,c){return this.optionsForRecord(a,!0,function(d,e){var f,h;h=this._filterData("before","update",d,a,b),d=h[0],f=h[1];if(d)c(d);else return new l.Request(g(e,{data:f,method:"PUT",success:P(function(d){return c.apply(null,this._filterData("after","update",void 0,a,d,b))},this),error:P(function(d){return c.apply(null,this._filterData("after","update",d,a,d.request.get("response"),b))},this)}))})},a.prototype.read=function(a,b,c){return this.optionsForRecord(a,!0,function(d,e){var f;f=this._filterData("before","read",d,a,b),d=f[0],a=f[1],b=f[2];if(d)c(d);else return new l.Request(g(e,{data:b,method:"GET",success:P(function(d){return c.apply(null,this._filterData("after","read",void 0,a,d,b))},this),error:P(function(d){return c.apply(null,this._filterData("after","read",d,a,d.request.get("response"),b))},this)}))})},a.prototype.readAll=function(a,b,c){return this.optionsForCollection(b,function(a,d){var e;e=this._filterData("before","readAll",a,b),a=e[0],b=e[1];if(a)c(a);else return new l.Request(g(d,{data:b,method:"GET",success:P(function(a){return c.apply(null,this._filterData("after","readAll",void 0,a,b))},this),error:P(function(a){return c.apply(null,this._filterData("after","readAll",a,a.request.get("response"),b))},this)}))})},a.prototype.after("readAll",h(function(a){var b,c,d;b=a[0],c=a[1],d=b[this.collectionJsonNamespace]?b[this.collectionJsonNamespace]:b;return[d,b,c]})),a.prototype.after("readAll",h(function(a){var b,c,d,e;d=a[0],e=a[1],c=a[2];return[function(){var a,c,e;e=[];for(a=0,c=d.length;a<c;a++)b=d[a],e.push(this.getRecordFromData(b));return e}.call(this),e,c]})),a.prototype.destroy=function(a,b,c){return this.optionsForRecord(a,!0,function(d,e){var f;f=this._filterData("before","destroy",d,a,b),d=f[0],a=f[1],b=f[2];if(d)c(d);else return new l.Request(g(e,{method:"DELETE",success:P(function(d){return c.apply(null,this._filterData("after","destroy",void 0,a,d,b))},this),error:P(function(d){return c.apply(null,this._filterData("after","destroy",d,a,d.request.get("response"),b))},this)}))})};return a}(),l.View=function(){function b(a){var c;this.contexts=[],b.__super__.constructor.call(this,a);if(c=this.get("context"))this.contexts.push(c),this.unset("context")}var a;O(b,l.Object),a={},b.prototype.source="",b.prototype.html="",b.prototype.node=null,b.prototype.contentFor=null,b.prototype.ready=b.eventOneShot(function(){}),b.prototype.prefix="views",b.observeAll("source",function(){return setTimeout(P(function(){return this.reloadSource()},this),0)}),b.prototype.reloadSource=function(){var b;b=this.get("source");if(!!b)return a[b]?this.set("html",a[b]):new l.Request({url:""+this.prefix+"/"+this.source,type:"html",success:P(function(c){a[b]=c;return this.set("html",c)},this),error:function(a){throw new Error("Could not load view from "+url)}})},b.observeAll("html",function(a){var b;b=this.node||document.createElement("div"),b.innerHTML=a;if(this.node!==b)return this.set("node",b)}),b.observeAll("node",function(a){if(!!a){this.ready.fired=!1,this._renderer&&this._renderer.forgetAll();if(a){this._renderer=new l.Renderer(a,P(function(){var b,c;b=this.contentFor,typeof b=="string"&&(this.contentFor=(c=l.DOM._yields)!=null?c[b]:void 0);if(this.contentFor&&a){this.contentFor.innerHTML="";return this.contentFor.appendChild(a)}},this),this.contexts);return this._renderer.rendered(P(function(){return this.ready(a)},this))}}});return b}(),l.Renderer=function(){function c(a,b,d){this.node=a,d==null&&(d=[]),this.resume=P(this.resume,this),this.start=P(this.start,this),c.__super__.constructor.apply(this,arguments),b!=null&&this.parsed(b),this.context=d instanceof o?d:function(a,b,c){c.prototype=a.prototype;var d=new c,e=a.apply(d,b);return typeof e=="object"?e:d}(o,d,function(){}),setTimeout(this.start,0)}var a,b;O(c,l.Object),c.prototype.start=function(){this.startTime=new Date;return this.parseNode(this.node)},c.prototype.resume=function(){this.startTime=new Date;return this.parseNode(this.resumeNode)},c.prototype.finish=function(){this.startTime=null,this.fire("parsed");return this.fire("rendered")},c.prototype.forgetAll=function(){},c.prototype.parsed=c.eventOneShot(function(){}),c.prototype.rendered=c.eventOneShot(function(){}),a=/data\-(.*)/,b=function(a,b){return a[0]==="foreach"?-1:b[0]==="foreach"?1:a[0]==="formfor"?-1:b[0]==="formfor"?1:a[0]==="bind"?-1:b[0]==="bind"?1:0},c.prototype.parseNode=function(c){var d,e,f,g,h,i,j,k,m,n,o,p,q,r,s,t;if(new Date-this.startTime>50)this.resumeNode=c,setTimeout(this.resume,0);else{if(typeof c.getAttribute=="function"){e=function(){var b,e,f,h,i;f=c.attributes,i=[];for(b=0,e=f.length;b<e;b++){d=f[b],g=(h=d.nodeName.match(a))!=null?h[1]:void 0;if(!g)continue;i.push(~(m=g.indexOf("-"))?[g.substr(0,m),g.substr(m+1),d.value]:[g,d.value])}return i}(),t=e.sort(b);for(p=0,q=t.length;p<q;p++){i=t[p],f=i[1],j=i.length===2?typeof (n=l.DOM.readers)[r=i[0]]=="function"?n[r](c,f,this.context,this):void 0:typeof (o=l.DOM.attrReaders)[s=i[0]]=="function"?o[s](c,f,i[2],this.context,this):void 0;if(j===!1){k=!0;break}}}return(h=this.nextNode(c,k))?this.parseNode(h):this.finish()}},c.prototype.nextNode=function(a,b){var c,d,e,f,g;if(!b){c=a.childNodes;if(c!=null?c.length:void 0)return c[0]}typeof (g=l.data(a,"onParseExit"))=="function"&&g();if(this.node!==a){f=a.nextSibling;if(f)return f;d=a;while(d=d.parentNode){typeof d.onParseExit=="function"&&d.onParseExit();if(this.node===d)return;e=d.nextSibling;if(e)return e}}};return c}(),n=function(){function d(){var a;d.__super__.constructor.apply(this,arguments),this.parseFilter(),this.nodeChange||(this.nodeChange=P(function(a,b){if(this.key)return this.get("keyContext").set(this.key,this.node.value)},this)),this.dataChange||(this.dataChange=function(a,b){return l.DOM.valueForNode(this.node,a)}),a=!0,this.only!=="write"&&l.DOM.nodeIsEditable(this.node)&&l.DOM.events.change(this.node,P(function(){a=!1,this.nodeChange(this.node,this._keyContext||this.value,this);return a=!0},this)),this.observe("filteredValue",!0,P(function(b){if(a&&this.only!=="read")return this.dataChange(b,this.node,this)},this)),this}var a,b,c;O(d,l.Object),c=/(^|,)\s*(?!(?:true|false)\s*(?:$|,))([a-zA-Z][\w\.]*)\s*($|,)/g,a=/(?:\]\.)(.+?)(?=[\[\.]|\s*\||$)/,b=/(?!^\s*)\[(.*?)\]/g,d.accessor("filteredValue",function(){var a,b;b=this.get("unfilteredValue"),this.get("key")&&(a=this.get("keyContext"));return this.filterFunctions.length>0?this.filterFunctions.reduce(P(function(b,c,d){var e;e=this.filterArguments[d].map(function(a){return a._keypath?a.context.get(a._keypath):a});return c.call.apply(c,[a,b].concat(M.call(e)))},this),b):b}),d.accessor("unfilteredValue",function(){return(y=this.get("key"))?this.get("keyContext."+y):this.get("value")}),d.accessor("keyContext",function(){var a,b;this._keyContext||(b=this.renderContext.findKey(this.key),a=b[0],this._keyContext=b[1]);return this._keyContext}),d.prototype.parseFilter=function(){var c,d,e,f,g,h,i,j,k;this.filterFunctions=[],this.filterArguments=[],i=this.keyPath;while(a.test(i))i=i.replace(a,"]['$1']");g=i.replace(b," | get $1 ").replace(/'/g,'"').split(/(?!")\s+\|\s+(?!")/);try{h=this.parseSegment(j=g.shift())[0]}catch(m){}h&&h._keypath?this.key=h._keypath:this.value=h;if(g.length){while(f=g.shift()){k=f.indexOf(" "),~k?(e=f.substr(0,k),c=f.substr(k)):e=f;if(d=l.Filters[e]){this.filterFunctions.push(d);if(c)try{this.filterArguments.push(this.parseSegment(c))}catch(m){}else this.filterArguments.push([])}}return this.filterArguments=this.filterArguments.map(P(function(a){return a.map(P(function(a){var b,c;a._keypath&&(c=this.renderContext.findKey(a._keypath),b=c[0],a.context=c[1]);return a},this))},this))}},d.prototype.parseSegment=function(a){return JSON.parse("["+a.replace(c,'$1{"_keypath": "$2"}$3')+"]")};return d}(),o=function(){function b(){var a;a=1<=arguments.length?M.call(arguments,0):[],this.contexts=a,this.storage=new l.Object,this.defaultContexts=[this.storage],l.currentApp&&this.defaultContexts.push(l.currentApp)}var a;b.prototype.findKey=function(a){var b,c,d,e,g,h,i,j;b=a.split(".")[0].split("|")[0].trim(),j=[this.contexts,this.defaultContexts];for(h=0,i=j.length;h<i;h++){d=j[h],e=d.length;while(e--){c=d[e],c.get!=null?g=c.get(b):g=c[b];if(typeof g!="undefined")return[f(c,a),c]}}return[t.get(a),t]},b.prototype.set=function(){var a,b;a=1<=arguments.length?M.call(arguments,0):[];return(b=this.storage).set.apply(b,a)},b.prototype.push=function(a){return this.contexts.push(a)},b.prototype.pop=function(){return this.contexts.pop()},b.prototype.clone=function(){var a,b;a=function(a,b,c){c.prototype=a.prototype;var d=new c,e=a.apply(d,b);return typeof e=="object"?e:d}(this.constructor,this.contexts,function(){}),b=g({},this.storage),a.setStorage(b);return a},b.prototype.setStorage=function(a){return this.defaultContexts[0]=a},a=function(){function a(a,b){this.binding=a,this.localKey=b,this.localKey?this.accessor(this.localKey,function(){return this.binding.get("filteredValue")}):this.accessor(function(a){return this.binding.get("filteredValue."+a)})}O(a,l.Object),a.prototype.isBindingProxy=!0;return a}(),b.prototype.addKeyToScopeForNode=function(b,c,d){this.bind(b,c,P(function(b,c,e){return this.push(new a(e,d))},this),function(){return!0});return l.data(b,"onParseExit",P(function(){return this.pop()},this))},b.prototype.bind=function(a,b,c,d,e){var f;!e&&a&&typeof a!="string"&&(f=[a,b,c,d],b=f[0],c=f[1],d=f[2],e=f[3]);return new n({renderContext:this,keyPath:c,node:b,dataChange:d,nodeChange:e,only:a})};return b}(),l.DOM={readers:{read:function(a,b,c,d){return l.DOM.readers.bind(a,b,c,d,"read")},write:function(a,b,c,d){return l.DOM.readers.bind(a,b,c,d,"write")},bind:function(a,b,c,d,e){return a.nodeName.toLowerCase()==="input"&&a.getAttribute("type")==="checkbox"?l.DOM.attrReaders.bind(a,"checked",b,c,e):a.nodeName.toLowerCase()==="input"&&a.getAttribute("type")==="radio"?l.DOM.binders.radio(a,b,c,d,e):a.nodeName.toLowerCase()==="select"?l.DOM.binders.select(a,b,c,d,e):c.bind(e,a,b)},context:function(a,b,c){return c.addKeyToScopeForNode(a,b)},mixin:function(a,b,c){c.push(l.mixins),c.bind(a,b,function(b){return g(a,b)},function(){});return c.pop()},showif:function(a,b,c,d,e){var f;f=a.style.display||"";return c.bind(a,b,function(b){var c,d;if(!!b==!e){(d=l.data(a,"show"))!=null&&d.call(a);return a.style.display=f}return typeof (c=l.data(a,"hide"))=="function"?c.call(a):a.style.display="none"},function(){})},hideif:function(){var a,b;a=1<=arguments.length?M.call(arguments,0):[];return(b=l.DOM.readers).showif.apply(b,M.call(a).concat([!0]))},route:function(a,b,c){var d,f,g,h,j,k,m,n,o,p;if(b.substr(0,1)==="/")m=b;else{n=b.split("/"),b=n[0],d=n[1],o=c.findKey("dispatcher"),h=o[0],f=o[1],p=c.findKey(b),j=p[0],g=p[1],h||(h=l.currentApp.dispatcher);if(h&&j instanceof l.Model)d||(d="show"),k=w.underscore(w.pluralize(e(j.constructor))),m=h.findUrl({resource:k,id:j.get("id"),action:d});else if(j!=null?j.prototype:void 0)k=w.underscore(w.pluralize(e(j))),m=h.findUrl({resource:k,action:"index"})}if(!!m){a.nodeName.toUpperCase()==="A"&&(a.href=l.HashHistory.prototype.urlFor(m));return l.DOM.events.click(a,function(){return i(m)})}},partial:function(a,b,c,d){var e;d.prevent("rendered"),e=new l.View({source:b+".html",contentFor:a,contexts:Array.prototype.slice.call(c.contexts)});return e.ready(function(){d.allow("rendered");return d.fire("rendered")})},yield:function(a,b){return setTimeout(function(){return l.DOM.yield(b,a)},0)},contentfor:function(a,b){return setTimeout(function(){return l.DOM.contentFor(b,a)},0)}},attrReaders:{_parseAttribute:function(a){a==="false"&&(a=!1),a==="true"&&(a=!0);return a},write:function(a,b,c,d){return l.DOM.attrReaders.bind(a,b,c,d,"write")},bind:function(a,b,c,d,e){var f,g;switch(b){case"checked":case"disabled":case"selected":f=function(c){var d;a[b]=!!c;return typeof (d=l.data(a.parentNode,"updateBinding"))=="function"?d():void 0},g=function(a,d){return d.set(c,l.DOM.attrReaders._parseAttribute(a[b]))},l.data(a,b,{context:d,key:c});break;case"value":f=function(b){return a.value=b},g=function(a,b){return b.set(c,l.DOM.attrReaders._parseAttribute(a.value))};break;default:f=function(c){return a.setAttribute(b,c)},g=function(a,d){return d.set(c,l.DOM.attrReaders._parseAttribute(a.getAttribute(b)))}}return d.bind(e,a,c,f,g)},context:function(a,b,c,d){return d.addKeyToScopeForNode(a,c,b)},event:function(a,b,c,d){var e,f;f={callback:null,subContext:null},d.bind(a,c,function(a,b,c){f.callback=a;return f.subContext=c.get("keyContext")},function(){}),e=a.getAttribute("data-confirm");return l.DOM.events[b](a,function(){var a;if(!e||!!confirm(e))return(a=f.callback)!=null?a.apply(f.subContext,arguments):void 0})},addclass:function(a,b,c,d,e,f){b=b.replace(/\|/g," ");return d.bind(a,c,function(c){var d,e;d=a.className,e=d.indexOf(b)!==-1;if(!!c==!f){if(!e)return a.className=""+d+" "+b}else if(e)return a.className=d.replace(b,"")},function(){})},removeclass:function(){var a,b;a=1<=arguments.length?M.call(arguments,0):[];return(b=l.DOM.attrReaders).addclass.apply(b,M.call(a).concat([!0]))},foreach:function(a,b,c,d,e){var f,g,h,i,j,k,m,n;m=a.cloneNode(!0),m.removeAttribute("data-foreach-"+b),k=a.parentNode,n=a.nextSibling,e.parsed(function(){return k.removeChild(a)}),g=new l.SimpleHash,f=document.createDocumentFragment(),h=0,i={},j=!1,d.bind(a,c,function(a){var c,o,p,q;if(j){if(a===j)return;g.forEach(function(a,b){var c;return(c=b.parentNode)!=null?c.removeChild(b):void 0}),g.clear(),j.forget&&(j.forget("itemsWereAdded",i.add),j.forget("itemsWereRemoved",i.remove),j.forget("setWasSorted",i.reorder))}j=a,i.add=function(){var c,j,o,p,q,r,s,t,u;o=1<=arguments.length?M.call(arguments,0):[],h+=o.length,u=[];for(s=0,t=o.length;s<t;s++)j=o[s],e.prevent("rendered"),r=m.cloneNode(!0),g.set(j,r),q=d.clone(),p=new l.Object,p[b]=j,q.push(p),c=new l.Renderer(r,function(b){return function(){var c;typeof (c=l.data(b,"show"))=="function"?c.call(b,{before:n}):f.appendChild(b);if(--h===0){k.insertBefore(f,n),(typeof a.isSorted=="function"?a.isSorted():void 0)&&i.reorder();return f=document.createDocumentFragment()}}}(r),q),u.push(c.rendered(P(function(){e.allow("rendered");return e.fire("rendered")},this)));return u},i.remove=function(){var a,b,c,d,e,f;b=1<=arguments.length?M.call(arguments,0):[];for(d=0,e=b.length;d<e;d++)a=b[d],c=g.get(a),g.unset(a),c!=null&&typeof c.hide=="function"?c.hide(!0):c!=null&&(f=c.parentNode)!=null&&f.removeChild(c);return!0},i.reorder=function(){var b,c,d,e,f,h,i;c=a.toArray(),i=[];for(f=0,h=c.length;f<h;f++)b=c[f],e=g.get(b),d=l.data(e,"show"),i.push(typeof d=="function"?d.call(e,{before:n}):k.insertBefore(e,n));return i},i.arrayChange=function(a){i.remove.apply(i,a);return i.add.apply(i,a)};if(a){a.observe&&(a.observe("itemsWereAdded",i.add),a.observe("itemsWereRemoved",i.remove),a.setWasSorted?a.observe("setWasSorted",i.reorder):a.observe("toArray",i.arrayChange));if(a.forEach)return a.forEach(function(a){return i.add(a)});if(a.get&&(c=a.get("toArray")))return i.add.apply(i,c);q=[];for(o in a)p=a[o],q.push(i.add(o));return q}},function(){});return!1},formfor:function(a,b,c,d){var e;e=d.addKeyToScopeForNode(a,c,b);return l.DOM.events.submit(a,function(a,b){return b.preventDefault()})}},binders:{select:function(a,b,c,d,e){var f,g,h,i,j;j=c.findKey(b),f=j[0],g=j[1],i=P(function(){var c,d;d=a.multiple?function(){var b,d,e,f;e=a.children,f=[];for(b=0,d=e.length;b<d;b++)c=e[b],c.selected&&f.push(c.value);return f}():a.value,d.length===1&&(d=d[0]);return g.set(b,d)},this),h=P(function(){var b,c,d,e,f,g,h,i,j,k,m;j=a.children,m=[];for(h=0,i=j.length;h<i;h++)b=j[h],m.push((c=l.data(b,"selected"))?(f=c.context)&&(g=c.key)?(k=f.findKey(g),d=k[0],e=k[1],k,b.selected!==d?e.set(g,b.selected):void 0):void 0:void 0);return m},this);return d.rendered(function(){var d,f;d=function(b){var c,d,e,f,g,i,j,k,l,m,n,o,p;if(b instanceof Array){g={},o=a.children;for(i=0,l=o.length;i<l;i++)c=o[i],c.selected=!1,e=g[c.value],e?e.push(c):e=[c],g[c.value]=e;for(j=0,m=b.length;j<m;j++){f=b[j],p=g[f];for(k=0,n=p.length;k<n;k++)d=p[k],d.selected=!0}}else a.value=b;return h()},f=function(){i();return h()},l.data(a,"updateBinding",i);return c.bind(e,a,b,d,f)})},radio:function(a,b,c,d,e){var f,g;f=function(d){var e,f,g;g=c.findKey(b),e=g[0],f=g[1];if(e)return a.checked=e===a.value;if(a.checked)return f.set(b,a.value)},g=function(c,d){return d.set(b,l.DOM.attrReaders._parseAttribute(a.value))};return c.bind(e,a,b,f,g)}},events:{click:function(a,b){l.DOM.addEventListener(a,"click",function(){var c;c=1<=arguments.length?M.call(arguments,0):[],b.apply(null,[a].concat(M.call(c)));return c[0].preventDefault()}),a.nodeName.toUpperCase()==="A"&&!a.href&&(a.href="#");return a},change:function(a,b){var c,d,e,f,g,h;d=function(){switch(a.nodeName.toUpperCase()){case"TEXTAREA":return["keyup","change"];case"INPUT":if(a.type.toUpperCase()==="TEXT"){e=b,b=function(a){var b;if(!(a.type==="keyup"&&13<=(b=a.keyCode)&&b<=14))return e.apply(null,arguments)};return["keyup","change"]}return["change"];default:return["change"]}}(),h=[];for(f=0,g=d.length;f<g;f++)c=d[f],h.push(l.DOM.addEventListener(a,c,function(){var c;c=1<=arguments.length?M.call(arguments,0):[];return b.apply(null,[a].concat(M.call(c)))}));return h},submit:function(a,b){l.DOM.nodeIsEditable(a)?l.DOM.addEventListener(a,"keyup",function(){var c;c=1<=arguments.length?M.call(arguments,0):[];if(c[0].keyCode===13||c[0].which===13||c[0].keyIdentifier==="Enter"){b.apply(null,[a].concat(M.call(c)));return c[0].preventDefault()}}):l.DOM.addEventListener(a,"submit",function(){var c;c=1<=arguments.length?M.call(arguments,0):[],b.apply(null,[a].concat(M.call(c)));return c[0].preventDefault()});return a}},yield:function(a,b){var c,d,e,f;d=(e=l.DOM)._yields||(e._yields={}),d[a]=b;if(c=(f=l.DOM._yieldContents)!=null?f[a]:void 0){b.innerHTML="";if(c)return b.appendChild(c)}},contentFor:function(a,b){var c,d,e,f;c=(e=l.DOM)._yieldContents||(e._yieldContents={}),c[a]=b;if(d=(f=l.DOM._yields)!=null?f[a]:void 0){d.innerHTML="";if(b)return d.appendChild(b)}},valueForNode:function(a,b){var c;b==null&&(b=""),c=arguments.length>1;switch(a.nodeName.toUpperCase()){case"INPUT":return c?a.value=b:a.value;case"TEXTAREA":return c?a.innerHTML=a.value=b:a.innerHTML;case"SELECT":return a.value=b;default:return c?a.innerHTML=b:a.innerHTML}},nodeIsEditable:function(a){var b;return(b=a.nodeName.toUpperCase())==="INPUT"||b==="TEXTAREA"||b==="SELECT"},addEventListener:function(a,b,c){return a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent("on"+b,c)}},q=function(a){return function(b){if(typeof b!="undefined")return a.apply(this,arguments)}},v=l.Filters={get:q(function(a,b){return a.get!=null?a.get(b):a[b]}),equals:q(function(a,b){return a===b}),not:function(a){return!a},truncate:q(function(a,b,c){c==null&&(c="..."),a.length>b&&(a=a.substr(0,b-c.length)+c);return a}),"default":function(a,b){return a||b},prepend:function(a,b){return b+a},append:function(a,b){return a+b},downcase:q(function(a){return a.toLowerCase()}),upcase:q(function(a){return a.toUpperCase()}),pluralize:q(function(a,b){return w.pluralize(b,a)}),join:q(function(a,b){b==null&&(b="");return a.join(b)}),sort:q(function(a){return a.sort()}),map:q(function(a,b){return a.map(function(a){return a[b]})}),first:q(function(a){return a[0]}),meta:q(function(a,b){return a.meta.get(b)})},K=["capitalize","singularize","underscore","camelize"];for(F=0,H=K.length;F<H;F++)y=K[F],v[y]=q(w[y]);g(l,{cache:{},uuid:0,expando:("batman"+Math.random()).replace(/\D/g,""),canDeleteExpando:!0,noData:{embed:!0,object:"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000",applet:!0},hasData:function(a){a=a.nodeType?l.cache[a[l.expando]]:a[l.expando];return!!a&&!x(a)},data:function(a,b,c,d){var e,f,h,i,j,k,m;if(!!l.acceptData(a)){i=l.expando,f=typeof b=="string",j=a.nodeType,e=j?l.cache:a,h=j?a[l.expando]:a[l.expando]&&l.expando;if((!h||d&&h&&e[h]&&!e[h][i])&&f&&c===void 0)return;h||(j?a[l.expando]=h=++l.uuid:h=l.expando),e[h]||(e[h]={});if(typeof b=="object"||typeof b=="function")d?e[h][i]=g(e[h][i],b):e[h]=g(e[h],b);m=e[h],d&&(m[i]||(m[i]={}),m=m[i]),c!==void 0&&(m[w.camelize(b,!0)]=c),f?(k=m[b],k==null&&(k=m[w.camelize(b,!0)])):k=m;return k}},removeData:function(a,b,c){var d,e,f,g,h,i;if(!!l.acceptData(a)){g=l.expando,h=a.nodeType,d=h?l.cache:a,e=h?a[l.expando]:l.expando;if(!d[e])return;if(b){i=c?d[e][g]:d[e];if(i){i[b]||(b=w.camelize(b,!0)),delete i[b];if(!x(i))return}}if(c){delete d[e][g];if(!x(d[e]))return}f=d[e][g],l.canDeleteExpando||!d.setInterval?delete d[e]:d[e]=null;if(f){d[e]={};return d[e][g]=f}if(h)return l.canDeleteExpando?delete a[l.expando]:a.removeAttribute?a.removeAttribute(l.expando):a[l.expando]=null}},_data:function(a,b,c){return l.data(a,b,c,!0)},acceptData:function(a){var b;if(a.nodeName){b=l.noData[a.nodeName.toLowerCase()];if(b)return b!==!0&&a.getAttribute("classid")===b}return!0}}),x=function(a){var b;for(b in a)return!1;return!0};try{u=document.createElement("div"),delete u.test}catch(Q){l.canDeleteExpando=!1}z=l.mixins=new l.Object,l.Encoders={railsDate:{encode:function(a){return a},decode:function(a){var b;b=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*)?)Z$/.exec(a);if(b)return new Date(Date.UTC(+b[1],+b[2]-1,+b[3],+b[4],+b[5],+b[6]))}}},t=typeof exports!="undefined"&&exports!==null?(module.exports=l,global):(window.Batman=l,window),g(t,l.Observable),l.exportHelpers=function(a){var b,c,d,e;e=["mixin","unmixin","route","redirect","event","eventOneShot","typeOf","redirect"];for(c=0,d=e.length;c<d;c++)b=e[c],a["$"+b]=l[b];return a},l.exportGlobals=function(){return l.exportHelpers(t)},l.Request.prototype.send=function(a){var b;b={url:this.get("url"),type:this.get("method"),dataType:this.get("type"),data:a||this.get("data"),username:this.get("username"),password:this.get("password"),beforeSend:P(function(){return this.loading(!0)},this),success:P(function(a,b,c){this.set("status",c.status),this.set("response",a);return this.success(a)},this),error:P(function(a,b,c){this.set("status",a.status),this.set("response",a.responseText),a.request=this;return this.error(a)},this),complete:P(function(){this.loading(!1);return this.loaded(!0)},this)},this.get(!1)&&(b.contentType=this.get("contentType"));return jQuery.ajax(b)},l.mixins.animation={show:function(a){var b,c,d,e;b=$(this),c=function(){return b.show(600)},a?((d=a.append)!=null&&d.appendChild(this),(e=a.before)!=null&&e.parentNode.insertBefore(this,a.before),b.hide(),setTimeout(c,0)):c();return this},hide:function(a){$(this).hide(600,P(function(){var b;if(a)return(b=this.parentNode)!=null?b.removeChild(this):void 0},this));return this}}}).call(this)